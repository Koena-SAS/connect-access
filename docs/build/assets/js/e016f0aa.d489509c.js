"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[120],{1266:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return c},default:function(){return p}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],s={sidebar_position:3},l="Architecture",d={unversionedId:"developer-documentation/architecture",id:"developer-documentation/architecture",isDocsHomePage:!1,title:"Architecture",description:"General architecture",source:"@site/docs/developer-documentation/architecture.md",sourceDirName:"developer-documentation",slug:"/developer-documentation/architecture",permalink:"/docs/developer-documentation/architecture",editUrl:"https://gitlab.com/koena/connect-access/-/edit/master/docs/docs/developer-documentation/architecture.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Contributing",permalink:"/docs/developer-documentation/contributing"},next:{title:"Deployement",permalink:"/docs/user-documentation/deployement"}},c=[{value:"General architecture",id:"general-architecture",children:[],level:2},{value:"Backend",id:"backend",children:[{value:"Internationalization",id:"internationalization",children:[],level:3}],level:2},{value:"Frontend",id:"frontend",children:[{value:"Styling",id:"styling",children:[],level:3},{value:"Internationalization",id:"internationalization-1",children:[],level:3}],level:2},{value:"Frontend - backend communication",id:"frontend---backend-communication",children:[{value:"REST calls",id:"rest-calls",children:[],level:3},{value:"Stale While Revalidate",id:"stale-while-revalidate",children:[],level:3},{value:"Server side generation",id:"server-side-generation",children:[],level:3}],level:2},{value:"Testing strategy",id:"testing-strategy",children:[{value:"Unit Tests",id:"unit-tests",children:[],level:3},{value:"End to end tests",id:"end-to-end-tests",children:[],level:3}],level:2}],h={toc:c};function p(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"architecture"},"Architecture"),(0,o.kt)("h2",{id:"general-architecture"},"General architecture"),(0,o.kt)("p",null,"The application mainly consists of:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"a backend used as a REST API"),(0,o.kt)("li",{parentName:"ul"},"a single page application frontend consuming the backend API")),(0,o.kt)("p",null,"The frontend is always served from the backend, as a fully static resource in production, and as a redirection to the frontend server in development. That's why we always access the application from the backend server, including in development."),(0,o.kt)("p",null,"One of the advantages is that it is possible to compute data on server side by the Django view, and put it as HTML or JavaScript code directly in the index template page that is being used by React. This enables server side rendering to some extent."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The way the frontend is handled through the backend has been inspired from ",(0,o.kt)("a",{parentName:"p",href:"https://medium.com/@twagner000/django-create-react-app-without-ejecting-958251af362c"},"an article by Tristan Wagner"),", with the usage of ",(0,o.kt)("inlineCode",{parentName:"p"},"django-webpack-loader")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"webpack-bundle-tracker"),"."),(0,o.kt)("p",{parentName:"div"},"This configuration enables hot reload for the frontend in development, even if it is served through a backend view, and even when using Docker."))),(0,o.kt)("p",null,"There are 2 exceptions where the backend serves HTML pages instead of being used as a web API by another program:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"the browsable API provided by Django Rest Framework at ",(0,o.kt)("inlineCode",{parentName:"li"},"/api/")," when visited by a web browser, to be able to execute API calls through a web page without the frontend."),(0,o.kt)("li",{parentName:"ul"},"the admin interface provided by Django at ",(0,o.kt)("inlineCode",{parentName:"li"},"/admin/")," (and at a secret path configured in ",(0,o.kt)("inlineCode",{parentName:"li"},".envs/.production/.django")," for production environment) to be able to easily manipulate database objects without having a custom frontend for it.")),(0,o.kt)("h2",{id:"backend"},"Backend"),(0,o.kt)("p",null,"The backend is written in Python with the Django framework. Its codebase has been bootstrapped with ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/cookiecutter/cookiecutter-django"},"cookiecutter-django"),". The cookiecutter-django documentation can help a lot to understand the way the backend is structured."),(0,o.kt)("p",null,"It uses a PostgreSQL database on all environments, and a RabbitMQ message broker through Celery on production."),(0,o.kt)("h3",{id:"internationalization"},"Internationalization"),(0,o.kt)("p",null,"The interationalization is done through the Django main internationalization mechanism:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'from django.utils.translation import gettext_lazy as _\n\n_("Content to translate")\n')),(0,o.kt)("p",null,"Once some translatable content is created, you can regenerate the locale files, add the correct translation, and create a compiled versions of the translation."),(0,o.kt)("p",null,"The translated strings are in ",(0,o.kt)("inlineCode",{parentName:"p"},"backend/locale/[LANG]/django.po"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"python manage.py makemessages -l fr # create translations for french language\n# change the translations in /backend/locale/fr/django.po\npython manage.py compilemessages # compile the translation files\n")),(0,o.kt)("h2",{id:"frontend"},"Frontend"),(0,o.kt)("p",null,"The frontend is written in TypeScript with the React framework. Its codebase has been bootstrapped with ",(0,o.kt)("a",{parentName:"p",href:"https://create-react-app.dev/"},"create-react-app"),"."),(0,o.kt)("h3",{id:"styling"},"Styling"),(0,o.kt)("p",null,"The styling source files are in ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend/src/sass"),"."),(0,o.kt)("p",null,"The styling is done with ",(0,o.kt)("a",{parentName:"p",href:"https://sass-lang.com/"},"SASS preprocessor"),". The files are organized with the ",(0,o.kt)("a",{parentName:"p",href:"https://kiranworkspace.com/sass-architecture/"},"7-1 architecture"),", and the code itself is organized with the ",(0,o.kt)("a",{parentName:"p",href:"http://getbem.com/"},"Block Element Modifier (BEM) methodology"),"."),(0,o.kt)("p",null,"This implies that the styling blocks are independent from the React components. They may be reused or be bigger or smaller than a specific component."),(0,o.kt)("h3",{id:"internationalization-1"},"Internationalization"),(0,o.kt)("p",null,"The internationalization is done with ",(0,o.kt)("a",{parentName:"p",href:"https://lingui.js.org/"},"LinguiJS"),". Mainly with ",(0,o.kt)("inlineCode",{parentName:"p"},"Trans")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"t")," macros."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'import { t, Trans } from "@lingui/macro";\n\nfunction MyComponent(): JSX.Element {\n  return (\n    <>\n      <Trans>Content to translate</Trans>\n      <AnotherComponent customProp={t`Content to translate`} />\n    </>\n  );\n}\n')),(0,o.kt)("p",null,"Once some translatable content is created, you can regenerate the locale files, add the correct translation, and create a compiled versions of the translation."),(0,o.kt)("p",null,"The translated strings are in ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend/src/locales/[LANG]/messages.po"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"yarn lang:extract # create translations for french and english languages\n# change the translations in /frontend/src/locales/fr/messages.po\nyarn lang:compile # compile the translation files\n")),(0,o.kt)("h2",{id:"frontend---backend-communication"},"Frontend - backend communication"),(0,o.kt)("h3",{id:"rest-calls"},"REST calls"),(0,o.kt)("p",null,"As the backend exposes a REST API, the main communication channel is the REST calls from the frontend. It is mainly done with ",(0,o.kt)("inlineCode",{parentName:"p"},"axios"),"."),(0,o.kt)("h3",{id:"stale-while-revalidate"},"Stale While Revalidate"),(0,o.kt)("p",null,"For all the resources that are regularly queried from the backend to stay up to date because the backend is the source of truth, we use ",(0,o.kt)("a",{parentName:"p",href:"https://swr.vercel.app/"},"SWR")," to handle de refetches when necessary. It is being used as a hook in the component that directly needs the resource."),(0,o.kt)("h3",{id:"server-side-generation"},"Server side generation"),(0,o.kt)("p",null,"React is injected in a Django template that is located in ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend/public/index.html"),". We are thus able to create a JavaScript variable called ",(0,o.kt)("inlineCode",{parentName:"p"},"window.SERVER_DATA")," in that template, and put inside anything useful from the Django view that handles the template (located at ",(0,o.kt)("inlineCode",{parentName:"p"},"backend/connect_access/views.py"),")."),(0,o.kt)("p",null,"These data are available on React side immediately after the browser starts executing the JavaScript code, without the need to make a REST API call."),(0,o.kt)("h2",{id:"testing-strategy"},"Testing strategy"),(0,o.kt)("h3",{id:"unit-tests"},"Unit Tests"),(0,o.kt)("p",null,"Most of the backend and frontend code has been written with Test Driven Development style, by using the smallest possible iteration steps between the test and the implementation to drive the implementation from the tests. However these tests are closer to what can be called integration tests because they are done through the database for the backend, and through the UI (even if it is a light version of it with jsdom) for the frontend."),(0,o.kt)("p",null,"As a consequence, the execution of unit tests is slower than if it was pure Python or TypeScript code, especially for the frontend tests that take more than 30 seconds to execute on a modern computer. You are therefore encouraged to unit test complex logic outside of the database for the backend, and outside of React for the frontend."),(0,o.kt)("p",null,"Regarding the frontend tests, all the API calls are mocked. They return predefined data that the frontend expects from the backend."),(0,o.kt)("h3",{id:"end-to-end-tests"},"End to end tests"),(0,o.kt)("p",null,"For end to end tests everything is started as in production, and the tests are done through a real browser, in visible or headless mode."),(0,o.kt)("p",null,"These tests are much less numerous because they get easily flaky, and because one test can take from several seconds to execute and parallelization is more difficult in end to end mode."),(0,o.kt)("p",null,"Instead of testing all the possible successful and error paths like with unit tests, we test the main successful path for each main feature. It especially ensures the communication between the frontend and the backend is correct."))}p.isMDXComponent=!0}}]);